<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DOOM Eternal - Notas</title>
  <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/9/96/Doom_eternal_logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
    body{font-family:'Orbitron',sans-serif;background:radial-gradient(circle,#440000,#1a1a1a);color:#eaeaea}
    .container{max-width:800px;margin:50px auto}
    .btn-primary,.btn-danger,.btn-success,.btn-warning{border:2px solid #ff4500;color:#fff;text-transform:uppercase;font-weight:bold;box-shadow:0 0 10px #ff4500}
    .btn-primary:hover,.btn-danger:hover,.btn-success:hover,.btn-warning:hover{background-color:#ff4500;border-color:#ff7700;box-shadow:0 0 20px #ff7700}
    .nav-tabs .nav-link{font-weight:bold;color:#eaeaea;text-transform:uppercase}
    .nav-tabs .nav-link.active{background-color:#880000;color:#fff;border-color:#ff4500;box-shadow:0 0 10px #ff4500}
    .note-card{background:linear-gradient(135deg,#2b2b2b,#1a1a1a);color:#eaeaea;border:1px solid #ff4500;border-radius:10px;padding:15px;margin-bottom:15px}
    .note-access{border-left:5px solid #ffcc00}
    .note-query{border-left:5px solid #7f00ff}
    .note-server{border-left:5px solid #00cc00}
    .note-midoc{border-left:5px solid #00aaff}
    .floating-btn{position:fixed;bottom:20px;right:20px;background-color:#ff4500;color:#fff;border-radius:50%;width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 8px rgba(0,0,0,.3)}
    .modal-content{background:radial-gradient(circle,#440000,#1a1a1a);color:#eaeaea;border:2px solid #ff4500}
    .stats-card{background:linear-gradient(135deg,#333,#1a1a1a);color:#ffcc00;border-radius:10px;padding:20px;margin-bottom:20px;text-align:center;border:1px solid #ff4500}
    .stats-card h2{font-size:2rem;margin:0}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center text-danger mb-4">Control de Apuntes</h1>

    <div class="stats-card">
      <h2 id="totalNotes">0</h2>
      <p>Notas en la pestaña seleccionada</p>
    </div>

    <div class="input-group mb-4">
      <input type="text" class="form-control" id="searchBox" placeholder="Buscar por título o contenido..."/>
      <button class="btn btn-success ms-2" id="btnDownload">Descargar Notas</button>
      <button class="btn btn-warning ms-2" id="btnUpload">Cargar Notas</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none"/>
    </div>

    <ul class="nav nav-tabs mb-4" id="categoryTabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#accessNotes">Acceso</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#queryNotes">Query</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#serverNotes">Servidor</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#midocNotes">Midoc</button></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="accessNotes"></div>
      <div class="tab-pane fade" id="queryNotes"></div>
      <div class="tab-pane fade" id="serverNotes"></div>
      <div class="tab-pane fade" id="midocNotes"></div>
    </div>

    <button class="floating-btn" id="btnAdd"><i class="fas fa-plus"></i></button>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="addNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Agregar Nueva Nota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="noteForm">
            <div class="mb-3">
              <label for="noteTitle" class="form-label">Título</label>
              <input type="text" id="noteTitle" class="form-control" required/>
            </div>
            <div class="mb-3">
              <label for="noteContent" class="form-label">Contenido</label>
              <textarea id="noteContent" class="form-control" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="noteCategory" class="form-label">Categoría</label>
              <select id="noteCategory" class="form-select">
                <option value="Acceso">Acceso</option>
                <option value="Query">Query</option>
                <option value="Servidor">Servidor</option>
                <option value="Midoc">Midoc</option>
              </select>
            </div>
            <button type="submit" id="btnSaveNote" class="btn btn-primary w-100">Agregar Nota</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------- Utilidades crypto ----------
    const b64enc = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
    const b64dec = (str) => Uint8Array.from(atob(str), c => c.charCodeAt(0));
    const textEnc = new TextEncoder();
    const textDec = new TextDecoder();

    async function deriveKey(password, salt, iterations = 250000) {
      const keyMaterial = await crypto.subtle.importKey(
        'raw', textEnc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']
      );
      return crypto.subtle.deriveKey(
        { name: 'PBKDF2', hash: 'SHA-256', salt, iterations },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt','decrypt']
      );
    }

    async function encryptJson(obj, password) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password, salt);
      const data = textEnc.encode(JSON.stringify(obj));
      const ctBuf = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, data);
      return {
        v: 1,
        alg: 'AES-GCM',
        kdf: 'PBKDF2',
        iter: 250000,
        salt: b64enc(salt),
        iv: b64enc(iv),
        ct: b64enc(ctBuf)
      };
    }

    async function decryptJson(pkg, password) {
      if (!pkg || !pkg.ct || !pkg.salt || !pkg.iv) throw new Error('Formato no válido');
      const salt = b64dec(pkg.salt);
      const iv = b64dec(pkg.iv);
      const key = await deriveKey(password, salt, pkg.iter || 250000);
      const ctBuf = b64dec(pkg.ct);
      const ptBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ctBuf);
      return JSON.parse(textDec.decode(ptBuf));
    }

    // ---------- App ----------
    const normalizeCategory = (cat) => {
      const map = { acceso:'Acceso', query:'Query', servidor:'Servidor', midoc:'Midoc' };
      return map[String(cat || '').trim().toLowerCase()] || 'Acceso';
    };

    const notes = (JSON.parse(localStorage.getItem('notes')) || []).map(n => ({
      ...n, category: normalizeCategory(n.category)
    }));

    const categoriesEls = {
      Acceso: () => document.getElementById('accessNotes'),
      Query: () => document.getElementById('queryNotes'),
      Servidor: () => document.getElementById('serverNotes'),
      Midoc: () => document.getElementById('midocNotes'),
    };

    let editingIndex = null;

    const renderNotes = (filteredNotes = notes) => {
      Object.values(categoriesEls).forEach(getEl => {
        const el = getEl(); if (el) el.innerHTML = '';
      });

      filteredNotes.forEach((note, index) => {
        const cat = normalizeCategory(note.category);
        const container = categoriesEls[cat]();
        if (!container) return;

        const noteClass =
          cat === 'Acceso' ? 'note-access' :
          cat === 'Query' ? 'note-query' :
          cat === 'Servidor' ? 'note-server' : 'note-midoc';

        container.innerHTML += `
          <div class="note-card ${noteClass}">
            <h5>${note.title}</h5>
            <p>${note.content}</p>
            <button class="btn btn-sm btn-warning me-2" onclick="editNote(${index})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="deleteNote(${index})">Eliminar</button>
          </div>
        `;
      });

      updateStats();
    };

    const saveNote = (title, content, category) => {
      const cat = normalizeCategory(category);
      if (!title || !content) { alert('Título y contenido son obligatorios.'); return; }

      if (editingIndex !== null) {
        notes[editingIndex] = { title, content, category: cat };
        editingIndex = null;
      } else {
        notes.push({ title, content, category: cat });
      }
      localStorage.setItem('notes', JSON.stringify(notes));
      renderNotes();
    };

    const editNote = (index) => {
      const note = notes[index];
      document.getElementById('noteTitle').value = note.title;
      document.getElementById('noteContent').value = note.content;
      document.getElementById('noteCategory').value = note.category;
      document.getElementById('modalTitle').textContent = 'Editar Nota';
      document.getElementById('btnSaveNote').textContent = 'Guardar Cambios';
      editingIndex = index;

      const modal = new bootstrap.Modal(document.getElementById('addNoteModal'));
      modal.show();
    };
    window.editNote = editNote;

    const deleteNote = (index) => {
      if (confirm('¿Seguro que deseas eliminar esta nota?')) {
        notes.splice(index, 1);
        localStorage.setItem('notes', JSON.stringify(notes));
        renderNotes();
      }
    };
    window.deleteNote = deleteNote;

    const updateStats = () => {
      const active = document.querySelector('.nav-link.active');
      if (!active) return;
      const activeTabId = active.getAttribute('data-bs-target').substring(1);
      const activeContainer = document.getElementById(activeTabId);
      const activeNotes = activeContainer ? activeContainer.children.length : 0;
      document.getElementById('totalNotes').textContent = activeNotes;

      const tabNames = { accessNotes:'Acceso', queryNotes:'Query', serverNotes:'Servidor', midocNotes:'Midoc' };
      document.title = tabNames[activeTabId] || 'Notas';
    };

    const searchNotes = () => {
      const term = document.getElementById('searchBox').value.toLowerCase();
      const filtered = notes.filter(n =>
        (n.title || '').toLowerCase().includes(term) ||
        (n.content || '').toLowerCase().includes(term)
      );
      renderNotes(filtered);
    };

    // ---- Descarga cifrada ----
    async function downloadNotesEncrypted() {
      const pwd = prompt('Ingresa una contraseña para cifrar las notas:');
      if (!pwd) return;

      try {
        const payload = await encryptJson(notes, pwd);
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'notas.notes.enc.json';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error(e);
        alert('No se pudo cifrar/exportar las notas.');
      }
    }

    // ---- Carga (detecta cifrado o plano) ----
    async function loadNotesFromFile(input) {
      const file = input.files[0];
      if (!file) return;
      const text = await file.text();

      try {
        const json = JSON.parse(text);

        // ¿Es paquete cifrado?
        const isEncrypted = json && json.ct && json.salt && json.iv;
        if (isEncrypted) {
          const pwd = prompt('Este archivo está cifrado. Ingresa la contraseña:');
          if (!pwd) return;
          try {
            const imported = await decryptJson(json, pwd);
            if (!Array.isArray(imported)) throw new Error('El archivo descifrado no es una lista de notas.');
            imported.forEach(n => notes.push({
              title: n.title || '',
              content: n.content || '',
              category: normalizeCategory(n.category)
            }));
            localStorage.setItem('notes', JSON.stringify(notes));
            renderNotes();
            alert('Notas descifradas y cargadas correctamente.');
          } catch (err) {
            console.error(err);
            alert('Contraseña incorrecta o archivo corrupto.');
          }
          return;
        }

        // Si no es cifrado, asumimos JSON plano de notas
        if (Array.isArray(json)) {
          json.forEach(n => notes.push({
            title: n.title || '',
            content: n.content || '',
            category: normalizeCategory(n.category)
          }));
          localStorage.setItem('notes', JSON.stringify(notes));
          renderNotes();
          alert('Notas cargadas exitosamente.');
        } else {
          alert('El archivo no contiene un formato válido de notas.');
        }
      } catch {
        alert('Error al leer el archivo.');
      } finally {
        input.value = '';
      }
    }

    const handleVisibilityChange = () => {
      if (document.hidden) document.title = '¡Regresa, Slayer!';
      else updateStats();
    };

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnAdd').addEventListener('click', () => {
        editingIndex = null;
        document.getElementById('noteForm').reset();
        document.getElementById('modalTitle').textContent = 'Agregar Nueva Nota';
        document.getElementById('btnSaveNote').textContent = 'Agregar Nota';
        const modal = new bootstrap.Modal(document.getElementById('addNoteModal'));
        modal.show();
      });

      document.getElementById('btnDownload').addEventListener('click', downloadNotesEncrypted);
      document.getElementById('btnUpload').addEventListener('click', () => document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change', function(){ loadNotesFromFile(this); });
      document.getElementById('searchBox').addEventListener('input', searchNotes);

      document.getElementById('noteForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('noteTitle').value.trim();
        const content = document.getElementById('noteContent').value.trim();
        const category = document.getElementById('noteCategory').value;
        saveNote(title, content, category);

        const modal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
        modal && modal.hide();
        e.target.reset();
      });

      document.querySelectorAll('.nav-link').forEach(tab => tab.addEventListener('shown.bs.tab', updateStats));
      document.addEventListener('visibilitychange', handleVisibilityChange);

      renderNotes();
    });
  </script>
</body>
</html>
