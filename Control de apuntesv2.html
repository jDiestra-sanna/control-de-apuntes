<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DOOM Eternal - Notas (localStorage)</title>
  <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/9/96/Doom_eternal_logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
    body{font-family:'Orbitron',sans-serif;background:radial-gradient(circle,#440000,#1a1a1a);color:#eaeaea}
    .container{max-width:980px;margin:30px auto}
    .btn-primary,.btn-danger,.btn-success,.btn-warning,.btn-info,.btn-secondary{
      border:2px solid #ff4500;color:#fff;text-transform:uppercase;font-weight:bold;box-shadow:0 0 10px #ff4500
    }
    .btn-primary:hover,.btn-danger:hover,.btn-success:hover,.btn-warning:hover,.btn-info:hover,.btn-secondary:hover{
      background-color:#ff4500;border-color:#ff7700;box-shadow:0 0 20px #ff7700
    }
    .nav-tabs .nav-link{font-weight:bold;color:#eaeaea;text-transform:uppercase}
    .nav-tabs .nav-link.active{background-color:#880000;color:#fff;border-color:#ff4500;box-shadow:0 0 10px #ff4500}
    .note-card{background:linear-gradient(135deg,#2b2b2b,#1a1a1a);color:#eaeaea;border:1px solid #ff4500;border-radius:10px;padding:15px;margin-bottom:15px}
    .floating-btn{position:fixed;bottom:20px;right:20px;background-color:#ff4500;color:#fff;border-radius:50%;width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 8px rgba(0,0,0,.3)}
    .modal-content{background:radial-gradient(circle,#440000,#1a1a1a);color:#eaeaea;border:2px solid #ff4500}
    .stats-card{background:linear-gradient(135deg,#333,#1a1a1a);color:#ffcc00;border-radius:10px;padding:16px;margin-bottom:16px;text-align:center;border:1px solid #ff4500}
    .stats-card h2{font-size:1.6rem;margin:0}
    .table-dark thead th{border-color:#ff4500}
    .table-dark.table-striped>tbody>tr:nth-of-type(odd)>*{--bs-table-accent-bg:rgba(255,69,0,.08)}
    .drag-handle{cursor:grab}
    .drag-over{outline:2px dashed #ff7700}
    .cat-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
    .badge-pill{border-radius:999px}

    /* Fecha en blanco y totalmente visible */
    .note-card .text-muted.small{ color:#ffffff !important; opacity:1 !important; }

    /* Acciones de la nota: orden, espacios y responsive */
    .note-actions{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;        /* espacio uniforme entre botones */
      margin-top:.5rem; /* separación del contenido */
      align-items:center;
    }
    /* En pantallas medianas/altas, alineamos a la izquierda con buen espaciado */
    @media (min-width: 768px){
      .note-actions{ justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center text-danger mb-3">Control de Apuntes</h1>

    <div class="stats-card">
      <h2 id="totalNotes">0</h2>
      <p>Notas en la pestaña seleccionada</p>
    </div>

    <div class="input-group mb-3">
      <input type="text" class="form-control" id="searchBox" placeholder="Buscar por título o contenido..."/>
      <button class="btn btn-success ms-2" id="btnDownload">Descargar (cifrado)</button>
      <button class="btn btn-warning ms-2" id="btnUpload">Cargar</button>
      <button class="btn btn-secondary ms-2" id="btnManageCats">Gestionar Categorías</button>
      <button class="btn btn-info ms-2" id="btnToggleArchived" style="margin-top: 0.5rem;"><i class="fa-solid fa-box-archive me-1"></i> Mostrar/Ocultar archivadas</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none"/>
    </div>

    <ul class="nav nav-tabs mb-4" id="categoryTabs"></ul>
    <div class="tab-content" id="categoryContent"></div>

    <button class="floating-btn" id="btnAdd"><i class="fas fa-plus"></i></button>
  </div>

  <!-- Modal Nota -->
  <div class="modal fade" id="addNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Agregar Nueva Nota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="noteForm">
            <div class="mb-3">
              <label for="noteTitle" class="form-label">Título</label>
              <input type="text" id="noteTitle" class="form-control" required/>
            </div>
            <div class="mb-3">
              <label for="noteContent" class="form-label">Contenido</label>
              <textarea id="noteContent" class="form-control" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="noteCategory" class="form-label">Categoría</label>
              <select id="noteCategory" class="form-select"></select>
            </div>
            <div class="d-flex gap-2 mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="notePinned">
                <label class="form-check-label" for="notePinned">Fijar</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="noteArchived">
                <label class="form-check-label" for="noteArchived">Archivar</label>
              </div>
            </div>
            <button type="submit" id="btnSaveNote" class="btn btn-primary w-100">Agregar Nota</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Gestión de Categorías -->
  <div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-layer-group me-2"></i>Gestión de Categorías</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex gap-2 mb-3">
            <input type="text" id="newCategoryInput" class="form-control" placeholder="Nueva categoría (Ej: Incidencias, Ideas)"/>
            <input type="color" id="newCategoryColor" class="form-control form-control-color p-0" title="Color"/>
            <button class="btn btn-primary" id="btnAddCategory"><i class="fa-solid fa-plus me-1"></i>Agregar</button>
          </div>
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:5%"></th>
                  <th style="width:35%">Nombre</th>
                  <th style="width:15%" class="text-center">Notas</th>
                  <th style="width:25%">Color</th>
                  <th style="width:20%" class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody id="categoriesTableBody"></tbody>
            </table>
          </div>
          <small class="text-warning d-block mt-3">Arrastra filas para reordenar. No puedes eliminar la última categoría.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Renombrar Categoría -->
  <div class="modal fade" id="renameCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="renameCategoryForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-2"></i>Renombrar Categoría</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="renameCategoryInput" class="form-control" placeholder="Nuevo nombre" required/>
          <small class="text-secondary">Si el nuevo nombre ya existe, se <b>fusionarán</b> las notas.</small>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Eliminar Categoría -->
  <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="deleteCategoryForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-trash-can me-2"></i>Eliminar Categoría</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Vas a eliminar la categoría <b id="deleteCatName"></b> (<b id="deleteCatCount">0</b> notas).</p>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="deleteMode" id="deleteMove" value="move" checked>
            <label class="form-check-label" for="deleteMove">Mover sus notas a:</label>
          </div>
          <select id="reassignSelect" class="form-select my-2"></select>
          <div class="form-check mt-2">
            <input class="form-check-input" type="radio" name="deleteMode" id="deletePurge" value="purge">
            <label class="form-check-label text-danger" for="deletePurge">Eliminar también las notas</label>
          </div>
          <small class="text-warning d-block mt-2">No puedes eliminar la última categoría.</small>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ===================== Utilidades base (solo localStorage) ===================== */
    const LS_KEYS = { cats:'categories', notes:'notes', ver:'appVersion' };
    const APP_VERSION = 2;
    const DEFAULT_CATS = ['Acceso','Query','Servidor','Midoc'];
    const DEFAULT_COLORS = { Acceso:'#ffcc00', Query:'#7f00ff', Servidor:'#00cc00', Midoc:'#00aaff' };

    const textEnc = new TextEncoder(), textDec = new TextDecoder();
    const b64enc = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
    const b64dec = (str) => Uint8Array.from(atob(str), c => c.charCodeAt(0));
    const debounce = (fn, ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } };
    const slugify = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    function lsGet(k, def){ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? def; }catch{ return def; } }
    function lsSet(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    function uuid(){ return crypto.randomUUID ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2); }

    /* ===================== Crypto (AES-GCM + PBKDF2) ===================== */
    async function deriveKey(password, salt, iterations = 250000) {
      const keyMaterial = await crypto.subtle.importKey('raw', textEnc.encode(password), { name:'PBKDF2' }, false, ['deriveKey']);
      return crypto.subtle.deriveKey({ name:'PBKDF2', hash:'SHA-256', salt, iterations }, keyMaterial, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
    }
    async function encryptJson(obj, password) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password, salt);
      const data = textEnc.encode(JSON.stringify(obj));
      const ctBuf = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, data);
      return { v:1, alg:'AES-GCM', kdf:'PBKDF2', iter:250000, salt:b64enc(salt), iv:b64enc(iv), ct:b64enc(ctBuf) };
    }
    async function decryptJson(pkg, password) {
      const salt = b64dec(pkg.salt);
      const iv = b64dec(pkg.iv);
      const key = await deriveKey(password, salt, pkg.iter || 250000);
      const ptBuf = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, b64dec(pkg.ct));
      return JSON.parse(textDec.decode(ptBuf));
    }

    /* ===================== Estado ===================== */
    let categories = []; // [{name,color,order}]
    let notes = [];      // [{id,title,content,category,pinned,archived,createdAt,updatedAt}]
    let editingId = null;
    let showArchived = false;

    function normalizeLoadedCategories(raw){
      if (!Array.isArray(raw) || !raw.length) {
        return DEFAULT_CATS.map((name,i)=>({ name, color: DEFAULT_COLORS[name]||'#ff4500', order:i }));
      }
      if (typeof raw[0] === 'string') {
        return raw.map((name,i)=>({ name, color: DEFAULT_COLORS[name]||'#ff4500', order:i }));
      }
      return raw.map((c,i)=>({
        name: c.name || DEFAULT_CATS[i] || ('Cat'+i),
        color: c.color || DEFAULT_COLORS[c.name] || '#ff4500',
        order: Number.isFinite(c.order) ? c.order : i
      })).sort((a,b)=>a.order-b.order);
    }

    function normalizeLoadedNotes(raw, catNames){
      if (!Array.isArray(raw)) return [];
      return raw.map(n=>{
        const id = n.id || uuid();
        const cat = (n.category && catNames.has(n.category.toLowerCase())) ? n.category :
                    (Array.from(catNames)[0] || DEFAULT_CATS[0]);
        return {
          id,
          title: (n.title||'').toString(),
          content: (n.content||'').toString(),
          category: cat,
          pinned: !!n.pinned,
          archived: !!n.archived,
          createdAt: n.createdAt || Date.now(),
          updatedAt: n.updatedAt || Date.now()
        };
      });
    }

    function loadFromLocalStorage(){
      categories = normalizeLoadedCategories(lsGet(LS_KEYS.cats, null));
      const catSet = new Set(categories.map(c=>c.name.toLowerCase()));
      notes = normalizeLoadedNotes(lsGet(LS_KEYS.notes, []), catSet);
      lsSet(LS_KEYS.cats, categories);
      lsSet(LS_KEYS.notes, notes);
      lsSet(LS_KEYS.ver, APP_VERSION);
    }

    function saveCategories(){ lsSet(LS_KEYS.cats, categories); }
    function saveNotes(){ lsSet(LS_KEYS.notes, notes); }

    function catByName(name){ return categories.find(c=>c.name===name); }
    function countsVisible(){
      const map = {}; categories.forEach(c=>map[c.name]=0);
      notes.forEach(n => { if (!n.archived || showArchived) map[n.category] = (map[n.category]||0) + 1; });
      return map;
    }

    /* ===================== Render ===================== */
    async function renderCategoryTabsAndPanes(activeCat=null){
      categories.sort((a,b)=>a.order-b.order);
      const tabs = document.getElementById('categoryTabs');
      const content = document.getElementById('categoryContent');
      tabs.innerHTML=''; content.innerHTML='';

      const counts = countsVisible();
      categories.forEach((c, idx)=>{
        const slug = slugify(c.name);
        const paneId = `${slug}Notes`;
        const li = document.createElement('li'); li.className='nav-item';
        const btn = document.createElement('button');
        btn.className = 'nav-link' + ((activeCat? c.name===activeCat : idx===0)? ' active':'');
        btn.setAttribute('data-bs-toggle','tab');
        btn.setAttribute('data-bs-target','#'+paneId);
        btn.setAttribute('data-cat', c.name);
        btn.innerHTML = `<span class="cat-dot" style="background:${c.color||'#ff4500'}"></span>${c.name} ${counts[c.name]?`<span class="badge bg-danger ms-2 badge-pill">${counts[c.name]}</span>`:''}`;
        li.appendChild(btn); tabs.appendChild(li);

        const pane = document.createElement('div');
        pane.className = 'tab-pane fade' + ((activeCat? c.name===activeCat : idx===0)? ' show active':'');
        pane.id = paneId; pane.setAttribute('role','tabpanel'); content.appendChild(pane);

        btn.addEventListener('shown.bs.tab', updateStats);
      });

      renderNotes();
      updateStats();
    }

    function makeNoteCard(note){
      const color = (catByName(note.category)?.color)||'#ff4500';
      const card = document.createElement('div'); card.className='note-card'; card.style.borderLeft=`5px solid ${color}`;

      const header = document.createElement('div'); header.className='d-flex justify-content-between align-items-start';
      const title = document.createElement('h5'); title.textContent = note.title || '(Sin título)';
      const meta = document.createElement('div'); meta.className='text-muted small';
      meta.textContent = new Intl.DateTimeFormat('es-PE',{dateStyle:'medium',timeStyle:'short'}).format(new Date(note.updatedAt||note.createdAt));
      header.append(title, meta);

      const body = document.createElement('p'); body.textContent = note.content || '';

      /* Botonera ordenada y responsive */
      const btns = document.createElement('div'); btns.className = 'note-actions';
      const bEdit = document.createElement('button'); bEdit.className='btn btn-sm btn-warning';  bEdit.textContent='Editar';
      const bDel  = document.createElement('button'); bDel.className='btn btn-sm btn-danger';   bDel.textContent='Eliminar';
      const bPin  = document.createElement('button'); bPin.className='btn btn-sm btn-secondary'; bPin.textContent = note.pinned?'Desfijar':'Fijar';
      const bArc  = document.createElement('button'); bArc.className='btn btn-sm btn-secondary'; bArc.textContent = note.archived?'Desarchivar':'Archivar';

      bEdit.onclick = ()=> openEdit(note);
      bDel.onclick  = ()=>{ if(confirm('¿Eliminar nota?')){ notes = notes.filter(n=>n.id!==note.id); saveNotes(); renderNotes(); } };
      bPin.onclick  = ()=>{ note.pinned = !note.pinned; note.updatedAt=Date.now(); saveNotes(); renderNotes(); };
      bArc.onclick  = ()=>{ note.archived = !note.archived; note.updatedAt=Date.now(); saveNotes(); renderNotes(); };

      btns.append(bEdit,bDel,bPin,bArc);

      card.append(header,body,btns);
      return card;
    }

    function renderNotes(filtered=null){
      const list = filtered || [...notes];
      list.sort((a,b)=> (b.pinned - a.pinned) || (b.updatedAt - a.updatedAt));
      categories.forEach(c=>{
        const pane = document.getElementById(`${slugify(c.name)}Notes`);
        if (pane) pane.innerHTML='';
      });
      list.forEach(n=>{
        if (!showArchived && n.archived) return;
        const pane = document.getElementById(`${slugify(n.category)}Notes`);
        if (pane) pane.appendChild(makeNoteCard(n));
      });
      const counts = countsVisible();
      document.querySelectorAll('#categoryTabs .nav-link').forEach(btn=>{
        const cat = btn.dataset.cat;
        const base = `<span class="cat-dot" style="background:${catByName(cat)?.color||'#ff4500'}"></span>${cat}`;
        btn.innerHTML = base + (counts[cat]?` <span class="badge bg-danger ms-2 badge-pill">${counts[cat]}</span>`:'');
      });
      updateStats();
    }

    function updateStats(){
      const active = document.querySelector('#categoryTabs .nav-link.active');
      if (!active) return;
      const target = active.getAttribute('data-bs-target');
      const container = document.querySelector(target);
      const count = container ? container.children.length : 0;
      document.getElementById('totalNotes').textContent = count;
    }

    /* ===================== CRUD Notas ===================== */
    function openNew(){
      document.getElementById('noteForm').reset();
      editingId = null;
      document.getElementById('modalTitle').textContent='Agregar Nueva Nota';
      document.getElementById('btnSaveNote').textContent='Agregar Nota';
      const sel = document.getElementById('noteCategory');
      sel.innerHTML = categories.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
      const active = document.querySelector('#categoryTabs .nav-link.active');
      sel.value = active ? active.dataset.cat : categories[0].name;
      new bootstrap.Modal(document.getElementById('addNoteModal')).show();
    }

    function openEdit(note){
      editingId = note.id;
      document.getElementById('modalTitle').textContent='Editar Nota';
      document.getElementById('btnSaveNote').textContent='Guardar Cambios';
      document.getElementById('noteTitle').value = note.title;
      document.getElementById('noteContent').value = note.content;
      const sel = document.getElementById('noteCategory');
      sel.innerHTML = categories.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
      sel.value = note.category;
      document.getElementById('notePinned').checked = !!note.pinned;
      document.getElementById('noteArchived').checked = !!note.archived;
      new bootstrap.Modal(document.getElementById('addNoteModal')).show();
    }

    /* ===================== Gestión de Categorías ===================== */
    let renameCatOld = null, deleteCatName = null, dragSrcIndex = null;

    function countsAll(){
      const map = {}; categories.forEach(c=>map[c.name]=0);
      notes.forEach(n => { if (!n.archived) map[n.category] = (map[n.category]||0) + 1; });
      return map;
    }

    function renderCategoriesTable(){
      const tbody = document.getElementById('categoriesTableBody');
      const counts = countsAll();
      categories.sort((a,b)=>a.order-b.order);
      tbody.innerHTML = categories.map((c,idx)=>`
        <tr draggable="true" data-index="${idx}" data-name="${c.name}">
          <td class="text-center drag-handle"><i class="fa-solid fa-grip-lines"></i></td>
          <td><span class="cat-dot" style="background:${c.color||'#ff4500'}"></span>${c.name}</td>
          <td class="text-center">${counts[c.name]||0}</td>
          <td><input type="color" value="${c.color||'#ff4500'}" data-name="${c.name}" class="form-control form-control-color p-0"></td>
          <td class="text-end">
            <button class="btn btn-warning btn-sm me-2" data-action="rename" data-name="${c.name}">
              <i class="fa-regular fa-pen-to-square me-1"></i>Renombrar
            </button>
            <button class="btn btn-danger btn-sm" data-action="delete" data-name="${c.name}">
              <i class="fa-regular fa-trash-can me-1"></i>Eliminar
            </button>
          </td>
        </tr>
      `).join('');

      tbody.querySelectorAll('input[type="color"]').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const cat = categories.find(c=>c.name===e.target.dataset.name);
          if (!cat) return;
          cat.color = e.target.value; saveCategories(); renderCategoryTabsAndPanes(cat.name);
        });
      });
      tbody.querySelectorAll('button[data-action="rename"]').forEach(btn=>{
        btn.onclick = ()=>{
          renameCatOld = btn.dataset.name;
          document.getElementById('renameCategoryInput').value = renameCatOld;
          new bootstrap.Modal(document.getElementById('renameCategoryModal')).show();
        };
      });
      tbody.querySelectorAll('button[data-action="delete"]').forEach(btn=>{
        btn.onclick = ()=>{
          deleteCatName = btn.dataset.name;
          document.getElementById('deleteCatName').textContent = deleteCatName;
          document.getElementById('deleteCatCount').textContent = counts[deleteCatName]||0;
          const sel = document.getElementById('reassignSelect');
          sel.innerHTML = categories.filter(c=>c.name!==deleteCatName).map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
          document.getElementById('deleteMove').checked = true;
          document.getElementById('reassignSelect').disabled = false;
          new bootstrap.Modal(document.getElementById('deleteCategoryModal')).show();
        };
      });
      tbody.querySelectorAll('tr').forEach(row=>{
        row.addEventListener('dragstart', ()=>{ dragSrcIndex = +row.dataset.index; row.classList.add('dragging'); });
        row.addEventListener('dragover', (e)=>{ e.preventDefault(); row.classList.add('drag-over'); });
        row.addEventListener('dragleave', ()=> row.classList.remove('drag-over'));
        row.addEventListener('drop', (e)=>{
          e.preventDefault(); row.classList.remove('drag-over');
          const targetIndex = +row.dataset.index; if (dragSrcIndex===null || targetIndex===dragSrcIndex) return;
          const [moved] = categories.splice(dragSrcIndex,1); categories.splice(targetIndex,0,moved);
          categories.forEach((c,i)=> c.order=i); saveCategories();
          renderCategoriesTable(); renderCategoryTabsAndPanes(moved.name);
        });
        row.addEventListener('dragend', ()=>{ row.classList.remove('dragging'); dragSrcIndex=null; });
      });
    }

    /* ===================== Export / Import ===================== */
    function collectAllData(){ return { _meta:{v:1, exportedAt:new Date().toISOString()}, categories, notes }; }

    async function downloadEncrypted(){
      const pwd = prompt('Ingresa una contraseña para cifrar las notas:'); if (!pwd) return;
      try{
        const payload = await encryptJson(collectAllData(), pwd);
        const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href=url; a.download=`notas_${new Date().toISOString().replace(/[:.]/g,'-')}.enc.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      }catch(e){ console.error(e); alert('No se pudo exportar.'); }
    }

    async function loadFromFile(input){
      const file = input.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const json = JSON.parse(text);
        if (json && json.ct && json.salt && json.iv){
          const pwd = prompt('Archivo cifrado. Ingresa la contraseña:'); if(!pwd) return;
          const data = await decryptJson(json, pwd);
          if (!data || !Array.isArray(data.notes) || !Array.isArray(data.categories)) throw new Error('Formato inválido');
          categories = normalizeLoadedCategories(data.categories);
          const catSet = new Set(categories.map(c=>c.name.toLowerCase()));
          notes = normalizeLoadedNotes(data.notes, catSet);
          saveCategories(); saveNotes();
          await renderCategoryTabsAndPanes();
          alert('Notas importadas correctamente.');
        }else{
          alert('Archivo no reconocido como backup cifrado.');
        }
      }catch(e){ console.error(e); alert('Error al importar.'); }
      finally{ input.value=''; }
    }

    /* ===================== Búsqueda ===================== */
    const doSearch = debounce(()=>{
      const term = document.getElementById('searchBox').value.toLowerCase().trim();
      if (!term) return renderNotes();
      const filtered = notes.filter(n => (n.title||'').toLowerCase().includes(term) || (n.content||'').toLowerCase().includes(term));
      renderNotes(filtered);
    }, 250);

    /* ===================== Boot ===================== */
    window.addEventListener('DOMContentLoaded', async ()=>{
      loadFromLocalStorage();
      await renderCategoryTabsAndPanes();

      document.getElementById('btnAdd').onclick = openNew;
      document.getElementById('searchBox').addEventListener('input', doSearch);
      document.getElementById('btnDownload').onclick = downloadEncrypted;
      document.getElementById('btnUpload').onclick = ()=> document.getElementById('fileInput').click();
      document.getElementById('fileInput').onchange = function(){ loadFromFile(this); };
      document.getElementById('btnManageCats').onclick = ()=>{ renderCategoriesTable(); new bootstrap.Modal(document.getElementById('manageCategoriesModal')).show(); };
      document.getElementById('btnToggleArchived').onclick = ()=>{ showArchived = !showArchived; renderNotes(); };

      document.getElementById('noteForm').onsubmit = (e)=>{
        e.preventDefault();
        const payload = {
          title: document.getElementById('noteTitle').value.trim(),
          content: document.getElementById('noteContent').value.trim(),
          category: document.getElementById('noteCategory').value,
          pinned: document.getElementById('notePinned').checked,
          archived: document.getElementById('noteArchived').checked
        };
        if (!payload.title || !payload.content) return alert('Título y contenido son obligatorios.');
        if (editingId){
          const i = notes.findIndex(n=>n.id===editingId);
          if (i>=0) notes[i] = { ...notes[i], ...payload, updatedAt: Date.now() };
          editingId = null;
        }else{
          notes.push({ id: uuid(), ...payload, createdAt: Date.now(), updatedAt: Date.now() });
        }
        saveNotes();
        bootstrap.Modal.getInstance(document.getElementById('addNoteModal')).hide();
        renderNotes(); e.target.reset();
      };

      document.getElementById('renameCategoryForm').onsubmit = (e)=>{
        e.preventDefault();
        const newName = document.getElementById('renameCategoryInput').value.trim();
        if (!newName) return alert('Nombre obligatorio.');
        const old = renameCatOld; if (!old) return;
        const exists = categories.find(c=>c.name.toLowerCase()===newName.toLowerCase());
        if (exists){
          notes.forEach(n=>{ if (n.category.toLowerCase()===old.toLowerCase()) n.category = exists.name; });
          categories = categories.filter(c=>c.name!==old);
        }else{
          const c = categories.find(c=>c.name===old); if (c) c.name = newName;
          notes.forEach(n=>{ if (n.category.toLowerCase()===old.toLowerCase()) n.category = newName; });
        }
        saveCategories(); saveNotes();
        bootstrap.Modal.getInstance(document.getElementById('renameCategoryModal')).hide();
        renderCategoriesTable(); renderCategoryTabsAndPanes(newName);
      };

      document.getElementById('deleteCategoryForm').addEventListener('change', (e)=>{
        if (e.target.name === 'deleteMode') document.getElementById('reassignSelect').disabled = (e.target.value !== 'move');
      });
      document.getElementById('deleteCategoryForm').onsubmit = (e)=>{
        e.preventDefault();
        if (categories.length<=1) return alert('No puedes eliminar la última categoría.');
        const mode = document.querySelector('input[name="deleteMode"]:checked').value;
        const reassignTo = document.getElementById('reassignSelect').value;
        const cat = deleteCatName;
        if (mode==='move'){
          if (!reassignTo) return alert('Elige destino.');
          notes.forEach(n=>{ if (n.category===cat) n.category = reassignTo; });
        } else {
          notes = notes.filter(n=>n.category!==cat);
        }
        categories = categories.filter(c=>c.name!==cat);
        categories.forEach((c,i)=> c.order=i);
        saveCategories(); saveNotes();
        bootstrap.Modal.getInstance(document.getElementById('deleteCategoryModal')).hide();
        renderCategoriesTable(); renderCategoryTabsAndPanes(categories[0]?.name);
      };

      document.addEventListener('visibilitychange', ()=>{ if(document.hidden) document.title='¡Regresa, Slayer!'; else updateStats(); });
    });
  </script>
</body>
</html>
